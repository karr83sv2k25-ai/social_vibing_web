rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isSignedIn() {
      return request.auth != null;
    }
    
    // Helper function to check if user ID matches
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    // Audio calls collection
    match /audio_calls/{communityId}/rooms/{roomId} {
      // Allow authenticated users to create and read audio rooms
      allow create: if isSignedIn() &&
                      request.resource.data.createdBy == request.auth.uid;
      allow read: if isSignedIn();
      
      // Allow update if user is authenticated (for joining, leaving, updating status)
      allow update: if isSignedIn();
      
      // Allow delete if user is authenticated
      allow delete: if isSignedIn();
      
      // Chat messages in audio call rooms
      match /chat/{chatId} {
        allow read: if isSignedIn();
        allow create: if isSignedIn();
        allow update: if isSignedIn();
        allow delete: if isSignedIn();
      }
    }
    
    // Voice/Video Calls (both 1-on-1 and group calls)
    match /calls/{callId} {
      // Allow read if user is authenticated
      // For 1-on-1: caller or receiver
      // For group: anyone authenticated (they'll check groupId exists)
      allow read: if isSignedIn();
      
      // Allow create if user is the caller (callerId must match auth user)
      allow create: if isSignedIn() && 
                      request.resource.data.callerId == request.auth.uid;
      
      // Allow update if user is authenticated
      // This allows joining group calls and updating call status
      allow update: if isSignedIn();
      
      // Allow delete if user is authenticated and involved in the call
      allow delete: if isSignedIn();
      
      // Chat messages in calls
      match /chat/{chatId} {
        allow read: if isSignedIn();
        allow create: if isSignedIn();
        allow update: if isSignedIn();
        allow delete: if isSignedIn();
      }
    }
    
    // Communities collection
    match /communities/{communityId} {
      allow read: if isSignedIn();
      allow write: if isSignedIn();
      
      // Posts subcollection
      match /posts/{postId} {
        allow read: if isSignedIn();
        allow create: if isSignedIn();
        allow update: if isSignedIn();
        allow delete: if isSignedIn() && 
                        (resource.data.authorId == request.auth.uid || 
                         get(/databases/$(database)/documents/communities/$(communityId)).data.uid == request.auth.uid);
        
        // Comments subcollection
        match /comments/{commentId} {
          allow read: if isSignedIn();
          allow create: if isSignedIn();
          allow update: if isSignedIn() && resource.data.authorId == request.auth.uid;
          allow delete: if isSignedIn() && resource.data.authorId == request.auth.uid;
        }
      }
      
      // Blogs subcollection
      match /blogs/{blogId} {
        allow read: if isSignedIn();
        allow create: if isSignedIn();
        allow update: if isSignedIn();
        allow delete: if isSignedIn() && 
                        (resource.data.authorId == request.auth.uid || 
                         get(/databases/$(database)/documents/communities/$(communityId)).data.uid == request.auth.uid);
        
        // Comments subcollection for blogs
        match /comments/{commentId} {
          allow read: if isSignedIn();
          allow create: if isSignedIn();
          allow update: if isSignedIn() && resource.data.authorId == request.auth.uid;
          allow delete: if isSignedIn() && resource.data.authorId == request.auth.uid;
        }
      }
      
      // Drafts subcollection
      match /drafts/{draftId} {
        allow read: if isSignedIn() && resource.data.authorId == request.auth.uid;
        allow create: if isSignedIn();
        allow update: if isSignedIn() && resource.data.authorId == request.auth.uid;
        allow delete: if isSignedIn() && resource.data.authorId == request.auth.uid;
      }
      
      // Messages subcollection
      match /messages/{messageId} {
        allow read: if isSignedIn();
        allow create: if isSignedIn();
        allow update: if isSignedIn();
        allow delete: if isSignedIn() && resource.data.senderId == request.auth.uid;
      }
    }
    
    // Users collection
    match /users/{userId} {
      allow read: if isSignedIn();
      allow create: if isOwner(userId);
      // Allow user to update their own profile
      allow update: if isOwner(userId);
      // Also allow updating followersCount and followingCount fields by authenticated users
      // This is needed when someone follows/unfollows another user
      allow update: if isSignedIn() && 
                      request.resource.data.diff(resource.data).affectedKeys()
                        .hasOnly(['followersCount', 'followingCount']);
    }
    
    // Community chats
    match /community_chats/{communityId}/messages/{messageId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn() && resource.data.senderId == request.auth.uid;
    }
    
    // Community members
    match /communities_members/{membershipId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }
    
    // Helper function to check conversation participant
    function isConversationParticipant(conversationId) {
      return isSignedIn() && 
        request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants;
    }
    
    // Helper function to check conversation admin
    function isConversationAdmin(conversationId) {
      return isSignedIn() && 
        request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.admins;
    }
    
    // Private conversations (list of user's conversations)
    match /conversations/{conversationId} {
      allow read: if isSignedIn() && 
                    (request.auth.uid in resource.data.participants);
      // FIXED: Allow create if user is in the new conversation's participants
      // Allow group creation with userSettings and unreadCount initialization
      allow create: if isSignedIn() && 
                      (request.auth.uid in request.resource.data.participants) &&
                      request.resource.data.participants is list &&
                      (
                        // 1-on-1 chat (simple validation)
                        request.resource.data.type == 'private' ||
                        // Group chat (creator must be in admins)
                        (request.resource.data.type == 'group' && 
                         request.auth.uid in request.resource.data.admins &&
                         request.auth.uid == request.resource.data.createdBy)
                      );
      allow update: if isSignedIn() && 
                      (request.auth.uid in resource.data.participants);
      allow delete: if isConversationAdmin(conversationId);
      
      // Messages within a conversation
      match /messages/{messageId} {
        allow read: if isConversationParticipant(conversationId);
        allow create: if isConversationParticipant(conversationId) && 
                        (request.resource.data.senderId == request.auth.uid ||
                         request.resource.data.type == 'system');
        allow update: if isConversationParticipant(conversationId) && 
                        (resource.data.senderId == request.auth.uid || 
                         request.resource.data.keys().hasOnly(['status', 'reactions', 'deletedFor']));
        allow delete: if resource.data.senderId == request.auth.uid;
      }
    }
    
    // User presence
    match /user_presence/{userId} {
      allow read: if isSignedIn();
      allow write: if request.auth.uid == userId;
    }
    
    // Message drafts
    match /message_drafts/{userId}/conversations/{conversationId} {
      allow read, write: if request.auth.uid == userId;
    }
    
    // Notification queue
    match /notification_queue/{notificationId} {
      allow read: if request.auth.uid == resource.data.userId;
      allow write: if isSignedIn();
    }
    
    // Top-level messages collection (for backward compatibility)
    match /messages/{messageId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource.data.senderId == request.auth.uid;
      allow delete: if isSignedIn() && resource.data.senderId == request.auth.uid;
    }
    
    // Marketplace collection
    match /marketplace/{itemId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }
    
    // Screen sharing rooms
    match /screening_rooms/{roomId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
      
      // Chat messages in screening room
      match /chat/{chatId} {
        allow read: if isSignedIn();
        allow create: if isSignedIn();
        allow update: if isSignedIn();
        allow delete: if isSignedIn();
      }
    }
    
    // Roleplay characters (both naming conventions for compatibility)
    match /roleplay_characters/{characterId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }
    
    match /roleplayCharacters/{characterId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }
    
    // Roleplay sessions
    match /roleplay_sessions/{communityId}/sessions/{sessionId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
      
      // Chat messages in roleplay session
      match /chat/{chatId} {
        allow read: if isSignedIn();
        allow create: if isSignedIn();
        allow update: if isSignedIn();
        allow delete: if isSignedIn();
      }
    }
    
    // Test collection (for testing Firebase+Hostinger setup)
    match /test/{testId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }
    
    // User following/followers subcollections
    match /users/{userId}/following/{followId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }
    
    match /users/{userId}/followers/{followerId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }
    
    // Reserved usernames collection
    match /usernames/{username} {
      allow get: if true;
      allow list: if false;
      allow create: if isSignedIn() &&
                     request.auth.uid == request.resource.data.ownerId &&
                     !exists(/databases/$(database)/documents/usernames/$(username));
      allow delete: if isSignedIn() && request.auth.uid == resource.data.ownerId;
      allow update: if false;
    }

    // Community events
    match /community_events/{eventId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }
    
    // User events (user-specific event participations)
    match /user_events/{userEventId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }
    
    // Friend requests
    match /friend_requests/{requestId} {
      allow read: if isSignedIn() && 
                    (resource.data.fromUserId == request.auth.uid || 
                     resource.data.toUserId == request.auth.uid);
      allow create: if isSignedIn() && 
                      request.resource.data.fromUserId == request.auth.uid;
      allow update: if isSignedIn() && 
                      (resource.data.toUserId == request.auth.uid || 
                       resource.data.fromUserId == request.auth.uid);
      allow delete: if isSignedIn() && 
                      (resource.data.fromUserId == request.auth.uid || 
                       resource.data.toUserId == request.auth.uid);
    }
    
    // Friends collection (user's friends list)
    match /users/{userId}/friends/{friendId} {
      allow read: if isSignedIn();
      allow write: if isSignedIn() && 
                     (request.auth.uid == userId || 
                      request.auth.uid == friendId);
    }
    
    // Blocked users collection
    match /users/{userId}/blocked/{blockedUserId} {
      allow read: if isSignedIn() && request.auth.uid == userId;
      allow write: if isSignedIn() && request.auth.uid == userId;
    }
    
    // Global Posts collection
    match /posts/{postId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.authorId == request.auth.uid;
      allow update: if isSignedIn();
      allow delete: if isSignedIn() && resource.data.authorId == request.auth.uid;
      
      // Comments on posts
      match /comments/{commentId} {
        allow read: if isSignedIn();
        allow create: if isSignedIn();
        allow update: if isSignedIn() && resource.data.userId == request.auth.uid;
        allow delete: if isSignedIn() && resource.data.userId == request.auth.uid;
      }
    }
    
    // Stories collection
    match /stories/{storyId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if isSignedIn();
      allow delete: if isSignedIn() && resource.data.userId == request.auth.uid;
    }
    
    // Polls collection
    match /polls/{pollId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if isSignedIn();
      allow delete: if isSignedIn() && resource.data.userId == request.auth.uid;
      
      // Poll votes subcollection
      match /votes/{voteId} {
        allow read: if isSignedIn();
        allow create: if isSignedIn();
        allow update: if isSignedIn();
        allow delete: if isSignedIn();
      }
    }
    
    // Quizzes collection
    match /quizzes/{quizId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if isSignedIn();
      allow delete: if isSignedIn() && resource.data.userId == request.auth.uid;
      
      // Quiz attempts subcollection
      match /attempts/{attemptId} {
        allow read: if isSignedIn();
        allow create: if isSignedIn();
        allow update: if isSignedIn() && resource.data.userId == request.auth.uid;
        allow delete: if isSignedIn() && resource.data.userId == request.auth.uid;
      }
    }
    
    // Questions collection
    match /questions/{questionId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if isSignedIn();
      allow delete: if isSignedIn() && resource.data.userId == request.auth.uid;
      
      // Answers to questions
      match /answers/{answerId} {
        allow read: if isSignedIn();
        allow create: if isSignedIn();
        allow update: if isSignedIn() && resource.data.userId == request.auth.uid;
        allow delete: if isSignedIn() && resource.data.userId == request.auth.uid;
      }
    }
    
    // Default rule - deny all access to other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
