rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isSignedIn() {
      return request.auth != null;
    }
    
    // Helper function to check if user ID matches
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    // Audio calls collection
    match /audio_calls/{communityId}/rooms/{roomId} {
      // Allow authenticated users to create and read audio rooms
      allow create: if isSignedIn();
      allow read: if isSignedIn();
      
      // Allow update if user is authenticated (for joining, leaving, updating status)
      allow update: if isSignedIn();
      
      // Allow delete if user created the room
      allow delete: if isSignedIn() && 
                      resource.data.createdBy == request.auth.uid;
    }
    
    // Communities collection
    match /communities/{communityId} {
      allow read: if isSignedIn();
      allow write: if isSignedIn();
      
      // Posts subcollection
      match /posts/{postId} {
        allow read: if isSignedIn();
        allow create: if isSignedIn();
        allow update: if isSignedIn();
        allow delete: if isSignedIn() && 
                        (resource.data.authorId == request.auth.uid || 
                         get(/databases/$(database)/documents/communities/$(communityId)).data.uid == request.auth.uid);
        
        // Comments subcollection
        match /comments/{commentId} {
          allow read: if isSignedIn();
          allow create: if isSignedIn();
          allow update: if isSignedIn() && resource.data.authorId == request.auth.uid;
          allow delete: if isSignedIn() && resource.data.authorId == request.auth.uid;
        }
      }
      
      // Blogs subcollection
      match /blogs/{blogId} {
        allow read: if isSignedIn();
        allow create: if isSignedIn();
        allow update: if isSignedIn();
        allow delete: if isSignedIn() && 
                        (resource.data.authorId == request.auth.uid || 
                         get(/databases/$(database)/documents/communities/$(communityId)).data.uid == request.auth.uid);
        
        // Comments subcollection for blogs
        match /comments/{commentId} {
          allow read: if isSignedIn();
          allow create: if isSignedIn();
          allow update: if isSignedIn() && resource.data.authorId == request.auth.uid;
          allow delete: if isSignedIn() && resource.data.authorId == request.auth.uid;
        }
      }
      
      // Drafts subcollection
      match /drafts/{draftId} {
        allow read: if isSignedIn() && resource.data.authorId == request.auth.uid;
        allow create: if isSignedIn();
        allow update: if isSignedIn() && resource.data.authorId == request.auth.uid;
        allow delete: if isSignedIn() && resource.data.authorId == request.auth.uid;
      }
      
      // Messages subcollection
      match /messages/{messageId} {
        allow read: if isSignedIn();
        allow create: if isSignedIn();
        allow update: if isSignedIn();
        allow delete: if isSignedIn() && resource.data.senderId == request.auth.uid;
      }
    }
    
    // Users collection
    match /users/{userId} {
      allow read: if isSignedIn();
      allow write: if isOwner(userId);
    }
    
    // Community chats
    match /community_chats/{communityId}/messages/{messageId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn() && resource.data.senderId == request.auth.uid;
    }
    
    // Community members
    match /communities_members/{membershipId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }
    
    // Private conversations (list of user's conversations)
    match /conversations/{conversationId} {
      allow read: if isSignedIn() && 
                    (request.auth.uid in resource.data.participants);
      allow create: if isSignedIn() && 
                      (request.auth.uid in request.resource.data.participants);
      allow update: if isSignedIn() && 
                      (request.auth.uid in resource.data.participants);
      allow delete: if isSignedIn() && 
                      (request.auth.uid in resource.data.participants);
      
      // Messages within a conversation
      match /messages/{messageId} {
        allow read: if isSignedIn() && 
                      (request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants);
        allow create: if isSignedIn() && 
                        (request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants);
        allow update: if isSignedIn() && resource.data.senderId == request.auth.uid;
        allow delete: if isSignedIn() && resource.data.senderId == request.auth.uid;
      }
    }
    
    // Top-level messages collection (for backward compatibility)
    match /messages/{messageId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource.data.senderId == request.auth.uid;
      allow delete: if isSignedIn() && resource.data.senderId == request.auth.uid;
    }
    
    // Marketplace collection
    match /marketplace/{itemId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }
    
    // Screen sharing rooms
    match /screening_rooms/{roomId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
      
      // Chat messages in screening room
      match /chat/{chatId} {
        allow read: if isSignedIn();
        allow create: if isSignedIn();
        allow update: if isSignedIn();
        allow delete: if isSignedIn();
      }
    }
    
    // Roleplay characters (both naming conventions for compatibility)
    match /roleplay_characters/{characterId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }
    
    match /roleplayCharacters/{characterId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }
    
    // Roleplay sessions
    match /roleplay_sessions/{communityId}/sessions/{sessionId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
      
      // Chat messages in roleplay session
      match /chat/{chatId} {
        allow read: if isSignedIn();
        allow create: if isSignedIn();
        allow update: if isSignedIn();
        allow delete: if isSignedIn();
      }
    }
    
    // Test collection (for testing Firebase+Hostinger setup)
    match /test/{testId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }
    
    // User following/followers subcollections
    match /users/{userId}/following/{followId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }
    
    match /users/{userId}/followers/{followerId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }
    
    // Community events
    match /community_events/{eventId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }
    
    // User events (user-specific event participations)
    match /user_events/{userEventId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }
    
    // Default rule - deny all access to other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
